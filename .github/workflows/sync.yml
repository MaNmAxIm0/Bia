name: Sincronizar Drive, Gerar Thumbs e Dados

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'

permissions:
  contents: write # Dá permissão para escrever (fazer commits) no repositório

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Instalar ferramentas e dependências
        run: |
          echo "--- A iniciar instalação de dependências ---"
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq unzip python3-pip
          pip3 install Pillow
          curl https://rclone.org/install.sh | sudo bash
          echo "--- Dependências instaladas com sucesso ---"

      - name: Configurar rclone
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          echo "--- A configurar o rclone ---"
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf
          echo "--- Rclone configurado ---"

      - name: Sincronizar Google Drive para Cloudflare R2
        run: |
          echo "--- A iniciar sincronização do Google Drive para o R2 ---"
          rclone sync "Drive:Portfólio Bia" "R2:bia-portfolio-assets" \
            --exclude "desktop.ini" \
            --exclude "/Thumbnails/**" \
            --exclude "/WatermarkedImages/**" \
            --exclude "/WatermarkedVideos/**" \
            -v
          echo "--- Sincronização Drive -> R2 concluída ---"

      - name: Gerar Thumbnails para Vídeos
        run: |
          echo "--- A iniciar geração de thumbnails para vídeos ---"
          mkdir -p temp_thumbs
          
          OLD_IFS="$IFS"
          IFS=$'\n'
          
          for video_file in $(rclone lsf "R2:bia-portfolio-assets/Vídeos" --files-only  ); do
            echo "A processar vídeo para thumbnail: ${video_file}"
            rclone copyto "R2:bia-portfolio-assets/Vídeos/${video_file}" "./${video_file}"
            
            if [ -f "./${video_file}" ]; then
              thumb_name="${video_file%.*}.jpg"
              ffmpeg -i "./${video_file}" -ss 00:00:01.00 -frames:v 1 -update 1 "temp_thumbs/${thumb_name}" > /dev/null 2>&1
              rm "./${video_file}"
            else
              echo "AVISO: Falha ao descarregar o vídeo '${video_file}'. A ignorar."
            fi
          done
          
          IFS="$OLD_IFS"
          
          rclone sync temp_thumbs "R2:bia-portfolio-assets/Thumbnails" -P
          echo "--- Geração de thumbnails concluída ---"

      - name: Gerar o ficheiro data.json com marcas de água
        run: |
          echo "--- A preparar para executar o script Python (process_files.py) ---"
          mkdir -p scripts/
          
          echo "A descarregar a fonte Montserrat..."
          curl -L -o scripts/Montserrat.ttf "https://github.com/google/fonts/raw/main/ofl/montserrat/Montserrat%5Bwght%5D.ttf"
          
          if [ -f "scripts/Montserrat.ttf" ]; then
            echo "Fonte descarregada. A iniciar o script principal de processamento..."
            # A execução do script Python começa aqui. As mensagens de progresso virão do próprio script.
            python3 scripts/process_files.py
            # Esta mensagem só aparecerá quando o script terminar com sucesso.
            echo "--- Script Python (process_files.py ) concluído com sucesso ---"
          else
            echo "ERRO: Falha ao descarregar a fonte Montserrat. A abortar."
            exit 1
          fi

      - name: Fazer commit e push do data.json
        run: |
          echo "--- A iniciar o processo de commit e push para o data.json ---"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data.json
          
          if ! git diff --quiet --exit-code --cached; then
            echo "Alterações detectadas no data.json. A fazer commit..."
            git commit -m "Atualiza data.json e media [skip ci]"
            git pull --rebase
            git push
            echo "--- Commit e push concluídos ---"
          else
            echo "Nenhuma alteração no data.json para fazer commit."
            echo "--- Processo de commit finalizado sem alterações ---"
          fi
